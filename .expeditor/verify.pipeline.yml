---
expeditor:
  defaults:
    buildkite:
      retry:
        automatic:
          limit: 1
      timeout_in_minutes: 30
      retry:
        automatic:
          limit: 1

steps:
  - label: "Functional Specs Ubuntu Priv :ruby: 2.6"
    commands:
      - /workdir/scripts/bk_tests/bk_container_prep.sh
      - apt-get update -y
      - apt-get install -y cron locales # needed for functional tests to pass
      - cd /workdir; bundle install --jobs=3 --retry=3 --path=vendor/bundle --without omnibus_package docgen ruby_prof
      - bundle exec rake spec:functional
    expeditor:
      cached_folders:
        - "vendor"
      executor:
        docker:
          image: rubydistros/ubuntu-18.04
          privileged: true

  - label: "Unit Specs Ubuntu :ruby: 2.6"
    commands:
      - /workdir/scripts/bk_tests/bk_container_prep.sh
      - bundle install --jobs=3 --retry=3 --without omnibus_package docgen ruby_prof
      - bundle exec rake spec:unit
      - bundle exec rake component_specs
    expeditor:
      cached_folders:
        - "vendor"
      executor:
        docker:
          image: rubydistros/ubuntu-18.04

  - label: "Functional Specs Windows Priv :ruby: 2.6"
    commands:
      - scripts/bk_tests/bk_win_functional.ps1
    expeditor:
      cached_folders:
        - "vendor"
      executor:
        windows:
          privileged: true
          shell: ["powershell", "-Command"]

  - label: "Unit Specs Windows :ruby: 2.6"
    commands:
      - /workdir/scripts/bk_tests/bk_win_unit.ps1
    expeditor:
      cached_folders:
        - "vendor"
      executor:
        docker:
          host_os: windows
          environment:
            - FORCE_FFI_YAJL=ext
            - CHEF_LICENSE=accept-no-persist
          shell: ["powershell", "-Command"]