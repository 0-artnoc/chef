---
driver:
  name: azurerm

driver_config:
  subscription_id: 80b824de-ec53-4116-9868-3deeab10b0cd
  location: West US2
  machine_size: Standard_B4ms

provisioner:
  name: chef_zero
  produce_name: chef
  install_strategy: skip
  deprecations_as_errors: true
  chef_license: accept-no-persist
  client_rb:
    diff_disabled: true
    always_dump_stacktrace: true

lifecycle:
  pre_converge:
    - remote: echo "Downloading Git"
    - remote: Invoke-WebRequest -UseBasicParsing -uri https://github.com/git-for-windows/git/releases/download/v2.26.2.windows.1/PortableGit-2.26.2-64-bit.7z.exe -OutFile \opscode\chef\bin\git.exe
    - remote: git.exe --version
    - remote: echo "Chef container's Chef / Ohai release:"
    - remote: \opscode\chef\bin\chef-client.bat -v
    - remote: \opscode\chef\bin\ohai.bat -v
    - remote: \opscode\chef\embedded\bin\rake.bat --version
    - remote: \opscode\chef\embedded\bin\bundle.bat -v
    - remote: \opscode\chef\embedded\bin\gem.bat install appbundler appbundle-updater --no-doc
    - remote: \opscode\chef\embedded\bin\appbundle-updater.bat chef ohai <%= File.readlines('../Gemfile.lock', File.expand_path(File.dirname(__FILE__))).find { |l| l =~ /^\s+ohai \((\d+\.\d+\.\d+)\)/ }; 'v' + $1 %> --tarball --github chef/ohai
    - remote: \opscode\chef\embedded\bin\appbundle-updater.bat chef chef <%= ENV['BUILDKITE_COMMIT']  || %x(git rev-parse HEAD).chomp %> --tarball --github chef/chef
    - remote: echo "Installed Chef \ Ohai release:"
    - remote: \opscode\chef\bin\chef-client.bat -v
    - remote: \opscode\chef\bin\ohai.bat -v

transport:
  name: winrm

verifier:
  name: inspec
  format: progress

platforms:
- name: windows-10
  driver:
    image_id: /subscriptions/80b824de-ec53-4116-9868-3deeab10b0cd/resourceGroups/EDM_Master_Storage_Resource_Group/providers/Microsoft.Compute/images/chef16-win-10
    use_managed_disk: true
    winrm_powershell_script: |-
      Set-WSManQuickConfig -Force -SkipNetworkProfileCheck
      netsh advfirewall firewall set rule name="Windows Remote Management (HTTP-In)" profile=public protocol=tcp localport=5985 remoteip=localsubnet new remoteip=any
      Set-PSRepository -Name PSGallery -InstallationPolicy Trusted

suites:
  - name: end-to-end
    run_list:
      - recipe[end_to_end::windows]
